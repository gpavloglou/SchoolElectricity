---
title: "School Electricity Analysis"
author: "George Pavloglou"
date: "September 2018"
output:
    html_document:
    fig_height: 7
    fig_width: 9
    keep_md: yes
    toc: yes
    toc_float: yes
---
```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```
_(Review the [README](https://github.com/gpavloglou/SchoolElectricity/blob/gh-pages/README.md) for background information on this project)_


# Scoping Population of Study

1) Schools for which electricity data was aggregated for the 2017-18 business plan
    a.	Schools with electricity data for period between Apr 2016 and March 2017
    b.	Including only schools that were open for all 12 months
    c.	only include schools for which enrolments were known during period
    d.	Must include floor area (floor area must not  equal 0 or be missing)
    e.	Include school type (e.g. 'Primary', 'Secondary', 'Special', etc)
    

2)	Indicate whether on xxxxxx Electricity Program. If on xxxx Electricity Program, then must be indicated as having had sensors installed for at least 12 months (**already confirmed in creation of dataset**).

3)	Indicate whether schools were confirmed to have used solar during period (**already confirmed in creation of dataset**). Note: schools indicated as having solar were confirmed as having used solar at least once during period based on whether there was a feed-in tariff payment identified in their billing.

4)	Indicate if they were xxxxxx Schools. But they must have been on this program for all 12 months (**already confirmed in creation of dataset**).

# Import, Inspect and Clean Data
## Import Data
```{r echo=TRUE, results='hide'}
# Set Working Directory
setwd("F:\\GeorgesFile\\R\\SchoolElectricity_VSBA_201803")

# Activate Packages
pckgs <- c("tidyverse","readxl","broom", "janitor", "oilabs","car", "caret", "gridExtra","grid","cowplot","PerformanceAnalytics","plotly","lmtest","sandwich", "het.test", "ggthemes", "jtools", "MASS", "estimatr")
sapply(pckgs, require, character.only = TRUE)

# Import Dataset
Elec201617 <- read_excel("SchoolElectricity201617v5.xlsx", na = c("","#N/A","NA"))

# Convert into Dataframe
Elec201617 <- as.data.frame(Elec201617)

# Inspect Data
# glimpse(Elec201617)
# View(Elec201617)
# summary(Elec201617)

```

## Clean Data (Round 1)
### Review missing data
```{r echo = T, results = 'hide'}
# Review missing data
Elec201617[!complete.cases(Elec201617),]
```
11 rows with missing data. Many of the schools with missing data are those where 'Match with Enrol?' == 'N'. If these are excluded, then fewer missing data to deal with. Exclude rows where Match with Enrol is "N".

```{r echo = T, results = 'hide'}
# Exclude rows where Match with Enrol is "N".
Elec201617 <- Elec201617 %>%
  filter(Enrol != "N")

# Inspect missing data again:
Elec201617[!complete.cases(Elec201617),]

# Since Geography for xxxxxxx School is known this can be filled in manually:
Elec201617[492,"Geography"] <- "Regional Centre"

# Re-check remaining missing data:
Elec201617[!complete.cases(Elec201617),]

```
Missing values under column header 'WeightedAvBuildingAge' for 4 schools. Will rely on R to remove these when performing calculations so leave these as NA for now.


### Check for any *numeric* values that are zero

```{r}
# Subset only numeric columns
Search0 <- Elec201617[,sapply(Elec201617,is.numeric)]

# Return rows where column value = 0
for(i in 1:ncol(Search0)){
  print(names(Search0[i]))
  print(which(Search0[,i]==0))
}  

rm(Search0)  

```
No zero values found for any numeric variables. 

### Filter out unwanted values based on Population Definition
```{r echo=TRUE, results='hide'}
Elec201617 %>%
  filter(QtyMonthsOpenInPeriod != 12) # New schools that opened at start of 2017. Filter these out.
Elec201617 <- Elec201617 %>%
  filter(QtyMonthsOpenInPeriod == 12)


# Weighted Av Building Age < 12 investigation

# Rename Column Name:
Elec201617 <- rename(Elec201617,
                     BuildAge = `WeightedAvBuildingAge\r\n(by original construction date)`)

# Now investigate for BuildAge < 12
Elec201617 %>% filter(BuildAge < 12)

```
**Explanation for BuildAge < 12:** A weighted average age of buildings (by original construction date) less than 12 must mean that some recent capital works have taken place in those 79 schools within the past year. The school where BuildAge = x officially opened in xxx 20xx and had first school term in xxx 20xx. This is therefore also a new school, which may have had more capital works or refurbishments between Apr 20xx and Mar 20xx. Keep BuildAge as is for now.

```{r echo=TRUE, results='hide'}
# Re-check data for further filtering:
#glimpse(Elec201617)
#summary(Elec201617)

# Check Match with Enrol
Elec201617 %>% filter(`Match with Enrol?` == "Y") # Returns 1,458 rows
nrow(Elec201617) # 1,458 rows
levels(Elec201617$`Match with Enrol?`) # No more 'Match with Enrol' == "N"

```
Confirmed that all criteria against 'Match with Enrol' variable met (as per previous filter). Now start removing variables unnecessary for analysis.  

### Remove Variables not needed for analysis
* Remove `Match with Enrol?`
* Remove QtyMonthsOpenInPeriod (all values = 12, therefore redundant)

```{r}
Elec201617 <- Elec201617 %>% 
  dplyr::select(., -c(`Match with Enrol?`, QtyMonthsOpenInPeriod))
```

### Rename Variables

```{r}
Elec201617 <- rename(
  	Elec201617,Elec = `Activity Quantity\r\n(kWh p.a.)`,
 	kWh_m2 = `Avg. kWh p.a. per m2\r\n(kWh/m2)`,
 	Cost = Est_Annual_Cost,
  Cost_kWh = `Est_Avg_$_per_kWh`,
  Type = School_Type,
  kWh_Enrol = kWhPerEnrol)

# glimpse(Elec201617)
```

### Transform Variables
   * Change specific variables into factor
   * Include additional cost variables
   * Round values of specific variables to two decimal places

#### Change specific variables into __factors:__
   
   * Type
   * SWEP
   * Solar
   * Geography
   * NatHERS
   * RSS
   * BCAZone

```{r}
# Change specific variables into factors:
Elec201617$Type <- as.factor(Elec201617$Type) # Type
Elec201617$SWEP <- as.factor(Elec201617$SWEP)   #SWEP
Elec201617$Solar <- as.factor(Elec201617$Solar) #Solar
Elec201617$Geography <- as.factor(Elec201617$Geography)  #Geography
Elec201617$NatHERS <- as.factor(Elec201617$NatHERS) #NatHERS
Elec201617$RSS <- as.factor(Elec201617$RSS) #RSS
Elec201617$BCA <- as.factor(Elec201617$BCA) #BCA
#str(Elec201617)

# 1) Rename and check levels: 
   # Rename level "Pri/Sec" into "PriSec"
       levels(Elec201617$Type)[levels(Elec201617$Type) == "Pri/Sec"] <- "PriSec"

   # Rename level "Regional Centre" into "Regional"
       levels(Elec201617$Geography)[levels(Elec201617$Geography) == "Regional Centre"] <-"Regional"

    # Re-check levels for $Type, $Geography, $BCA
        lapply(Elec201617[c("Type","Geography", "BCA")],levels) # changes confirmed

# 2) Choose Reference Level in Factor Variables:
# Let 'Primary' be the reference level for the factor 'Type'
# Let 'Urban' be the reference level for the factor 'Geography'
# Let 'Zone_6' be the reference level for the factor 'BCA'


Elec201617$Type <- factor(Elec201617$Type, 
                          levels = c("Primary", "Secondary", "PriSec", "Special","Language"))

Elec201617$Geography <- factor(Elec201617$Geography, 
                               levels = c("Urban", "Regional", "Rural"))

Elec201617$BCA <- factor(Elec201617$BCA, 
                         levels = c("Zone_6", "Zone_4","Zone_7"))

# levels(Elec201617$Type)  change confirmed 
# levels(Elec201617$Geography)  change confirmed
# levels(Elec201617$BCA) change confirmed

# Check whether factors are ordered:
# sapply(Elec201617[,c("Type","SWEP","Solar","Geography","NatHERS","RSS","BCA")],is.ordered)


```

#### Include additional cost variables

```{r} 
Elec201617 <-  Elec201617 %>% 
  mutate(Cost_m2 = Cost/Area,
         Cost_Enrol = Cost/Enrol)

```

#### Round 'double' type variables two decimal places
If the variable is of type "double", then use the following function: round(.,2) (i.e. round all data to two decimal places)

```{r} 
Elec201617 <- Elec201617 %>% 
  mutate_if(is.double, funs(round(.,2)))
```

### Change from data frame to a tibble
```{r} 
tbl1617 <- as.tbl(Elec201617)
```
Now ready to commence exploratory data analysis.

## Exploratory Data Analysis (Round 1)

```{r echo=T, results='hide'} 
# summary(tbl1617)
```
__Outstanding Observations:__

   * Only xx Language Schools existed in the entire school portfolio over the period, and these are captured here.
   * Two (2) NAs for BuildAge
   * Only 5 per cent (n = xxx) in this sample are on the SWEP electricity program
   * About 35 per cent (n = xxx) were identified as having used solar
   * Only 5 per cent (n = xxx) were in NaTHERS zones 20 or 27
   * Lowest kWh per sqm is 0.38 kWh per m^2^

### Plots and Summary Stats
#### Summary Plot: Electricity Consumption

```{r}
# Boxplot:
boxplotP <- ggplot(data = tbl1617, aes(x = "", y = Elec)) +
  geom_boxplot(alpha = 0.3, fill = "#3182bd", outlier.colour = "#3182bd") +
  stat_summary(fun.y = mean,
               geom = "point",
               shape = 4,
               size = 3) +
  ggtitle("Electricity Consumption",
          subtitle = "(kWh per annum)") +
  scale_y_continuous(breaks = seq(0,1200000, 300000)) +
  xlab("") +
  ylab("") +
  coord_flip() +
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = 0)  +   
  # remove if showing plot publically
  theme(axis.text = element_blank(),
        panel.grid = element_blank())
  

# Histogram:
histP <- ggplot(data = tbl1617, aes(x = Elec)) +
  geom_histogram( fill = "#3182bd", binwidth = 50000, colour = "white") +
  scale_x_continuous(breaks = seq(0,1200000, 300000)) +
  xlab("Electricity Usage (kWh p.a.)") +
  ylab("") +
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = 0) +   
  # remove figures if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

# Produce combined boxplot/histogram plot:
grid.arrange(boxplotP, histP, ncol = 1)

```

### Summary Statistics (Sample Electricity and Cost)
```{r  echo=T, results='hide'}
(Elec_SummaryStats <- sapply(tbl1617[,c("Elec","Cost")], summary))

```



### Summary Statistics: by School Type
#### Summary Tables
```{r echo=T, results='hide'}
# Summary Stats: Electricity by School Type
 by(tbl1617$Elec, tbl1617$Type, summary)

# Total Electricity by School Type
 tbl1617 %>%
   dplyr::select(Elec, Type) %>%
   group_by(Type) %>%
   summarise(Total = sum(Elec), 
                        Percent = round(Total/sum(tbl1617$Elec),3))

```
#### Summary Plot
```{r}
### Box Plots: Electricity consumption by School Type
ggplot(data = tbl1617, aes(x = Type, y = Elec, fill = Type)) +
  geom_boxplot(alpha = 0.5) +
  stat_summary(fun.y = mean,
               geom = "point",
               shape = 4,
               size = 3) +
  ggtitle("Annual Electricity Consumption by School Type",
          subtitle = "by School Type") +
  ylab("Annual Consumption (kWh p.a.)")+
  theme_minimal() + 
  scale_fill_calc() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = 0) + 
  # remove figures if showing plot publicly
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

### Density Plot: Electricity consumption by School Type
ggplot(data = tbl1617, aes(x = Elec, fill = Type)) +
  geom_density(alpha = 0.3) +
  ggtitle("Distribution of Electricity Consumption",
          "by School Type") +
  xlab("Electricity Consumption (kWh p.a.)") +
  ylab("")+
  facet_wrap(~Type) +
  scale_fill_calc()+
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust =0.5),
        axis.title = element_text(size = 9),
        legend.position = 0)+ 
  # remove figures if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())


```


### Explore Electricity per Floor area

```{r echo=T, results='hide'}
 tbl1617 %>%
   dplyr::select(kWh_m2, Type) %>%
   group_by(Type) %>%
   summarise(Mean = mean(kWh_m2), 
             StDev = round(sd(kWh_m2),3),
             MAD = mad(kWh_m2, constant = 1)) %>%
   arrange(desc(Mean))

```


```{r}
### Box Plots: Electricity per Floor Area consumption by School Type
ggplot(data = tbl1617, aes(x = Type, y = kWh_m2, fill = Type)) +
  geom_boxplot(alpha = 0.5) +
  stat_summary(fun.y = mean,
               geom = "point",
               shape = 4,
               size = 3) +
  ggtitle("Electricity Usage per Floor Area by School Type",
          subtitle = "(kWh/m2 per annum)") +
  scale_fill_calc() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = 0) +
  # remove figures if showing plot publicly
  theme(axis.text.y  = element_blank(),
        panel.grid = element_blank())    

### Density Plot: Electricity consumption per Floor Area by School Type
ggplot(data = tbl1617, aes(x = kWh_m2, fill = Type)) +
  geom_density(alpha = 0.3) +
  ggtitle("Distribution of Electricity per Floor Area Consumption",
          "by School Type") +
  xlab("Electricity Consumption (kWh/m2 p.a.)") +
  facet_wrap(~Type) +
  coord_cartesian(xlim = c(0,75)) +
  scale_fill_calc() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust =0.5),
        axis.title.y = element_blank(),
        legend.position = 0) +
  # remove figures if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())



```



## Explore kWh/m^2^ Outliers

```{r echo=T, results='hide'}
# Top 5 kWh/m2 outliers by School Type

 tbl1617  %>% 
   dplyr::select(1,5,3:4,8) %>%
   arrange(desc(kWh_m2)) %>%
   arrange(Type) %>% 
   group_by(Type) %>%
   top_n(5,kWh_m2)

tbl1617[1216,1:5]  #Unusually small floor Area


# Bottom 5 kWh/m2 outliers by School Type

 tbl1617  %>% 
   dplyr::select(1,5,3:4,8) %>%
   arrange(kWh_m2) %>%
   arrange(Type) %>% 
   group_by(Type) %>%
   top_n(-5,kWh_m2)


```
**N.B:** Extensive inspection of kWh/m2 outliers performed; involved examination, and where necessary, removal and/or update of observations.

## Clean Data (Round 2)

### Remove spurious observations
``` {r}
remove <- -c(233,  346,  796, 1049, 1137, 1216)    
tbl1617 <- tbl1617[remove,]  

```
### Update records
```{r eval=TRUE, echo=FALSE}
# names(tbl1617)

rcrd.update <- c(3,5,6,15,18,19) # columns to update


# Update Observation 1123
tbl1617[1123,rcrd.update] <- c(532850.26,23.67,85256.04,532850.26/794.6,85256.04/22513.5,85256.04/794.6)
# View(tbl1617[1123,])    

# Update Observation 894
tbl1617[894,rcrd.update] <- c(611060.35,33.36,116101.5,611060.35/2038.3,116101.5/18318.96,116101.5/2038.3)
#View(tbl1617[894,])

# Update Observation 262
rcrd.update1 <-  c(rcrd.update,7)
tbl1617[262,rcrd.update1] <- c(510056.64,42.3,86709.63,510056.64/510.6,86709.63/12058.64,86709.63/510.6,0.17)

#View(tbl1617[262,])  

# Update Observation 72
#View(tbl1617[72,])
tbl1617[72,rcrd.update1] <- c(384959.50,14.71,69292.71,384959.50/1065.975,69292.71/26161.08,69292.71/1065.975,0.18)



# Again round all 'double' variables to two decimal places (to tidy updated records)

tbl1617 <- tbl1617 %>% 
  mutate_if(is.double, funs(round(.,2)))

```


### Review Electricity per Enrolment Data
#### Summary Stats
```{r echo=T, results='hide'}

tbl1617 %>%
  dplyr::select(kWh_Enrol, Type) %>%
  group_by(Type) %>%
  summarise(Mean = mean(kWh_Enrol), 
            StDev = round(sd(kWh_Enrol),3),
            MAD = mad(kWh_Enrol, constant = 1)) %>% # Mean Absolute Deviation
  arrange(desc(Mean))


```

#### Plots
```{r}
ggplot(data = tbl1617, aes(x = Type, y = kWh_Enrol, fill = Type)) +
  geom_boxplot(alpha = 0.5) +
  stat_summary(fun.y = mean,
               geom = "point",
               shape = 4,
               size = 3) +
  ggtitle("Electricity Usage per Enrol by School Type",
          subtitle = "(kWh/enrol per annum)") +
  scale_fill_brewer(palette = "Set1")+
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = 0)+
  # remove figures if showing plot publicly
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

# Density Plot: Electricity consumption per Enrol by School Type
ggplot(data = tbl1617, aes(x = kWh_Enrol, fill = Type)) +
  geom_density(alpha = 0.3) +
  ggtitle("Distribution of Electricity per Enrol Consumption",
          "by School Type") +
  xlab("Electricity Consumption (kWh/enrol p.a.)") +
  facet_wrap(~Type) +
  coord_cartesian(xlim = c(0,2000)) +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust =0.5),
        axis.title.y =  element_blank(),
        legend.position = 0) +
  # remove figures if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

```


### Review kWh/enrol Outliers
```{r echo=T, results= 'hide'}
tbl1617  %>% 
  dplyr::select(1,15,3,14,8) %>%
  arrange(desc(kWh_Enrol)) %>%
  arrange(Type) %>% 
  group_by(Type) %>%
  top_n(7,kWh_Enrol)

# Bottom 7 kWh/enrol outliers by School Type
tbl1617  %>% 
  dplyr::select(1,15,3,14,8) %>%
  arrange(kWh_Enrol) %>%
  arrange(Type) %>% 
  group_by(Type) %>%
  top_n(-7,kWh_Enrol)

### Investigate xxxxxxx (xxxxxxx) Schools
tbl1617 %>%
  filter(between(Enrol,10,15)) %>%
  arrange(desc(Elec))

tbl1617 %>%
  filter(between(Area,700,900)) %>%
  arrange(desc(Elec))

```

Extensive inspection of kWh/enrol outliers performed. Involved examination, and where necessary, removal and/or update of observations.   

### Remove spurious kWh/enrol observations
```{r}
remove1 <- -c(6,  235,  587,  589,  892, 1099, 1133, 1212, 1225) # remove these rows 
tbl1617 <- tbl1617[remove1,]

# Remove objects no longer needed:
rm(remove,remove1,rcrd.update,rcrd.update1)

```

## Exploratory Data Analysis (Round 2)

### Breakdown of Observations
```{r echo = T, results = 'hide'}
# Breakdown of Observation by School Type
tbl1617%>%
  tabyl(Type, show_missing_levels = F)%>%
  adorn_totals(where = c("row"))%>%
  adorn_pct_formatting()

# Breakdown by School Type and Solar PV Use

tbl1617%>%
  mutate(Solar = fct_recode(Solar, "NoSolar"="0","Solar"="1"))%>%
  tabyl(Type,Solar, show_missing_levels = F)%>%
  adorn_totals(where = c("row","col"))%>%
  adorn_percentages()%>%
  adorn_pct_formatting()%>%
  adorn_ns(position = "front")

```


### Summary Statistics by Geography
```{r echo = T, results = 'hide'}
# Summary Electricity Consumption by Geography
by(tbl1617$Elec, tbl1617$Geography, summary)


# Total Electricity by Geography
tbl1617 %>%
  dplyr::select(Elec, Geography) %>%
  group_by(Geography) %>%
  summarise(n =  n(),
            Total = sum(Elec), 
            Percent = round(Total/sum(tbl1617$Elec),2))

```

**Comment:** approx. 70% of all electricity usage in this sample is by Urban schools.  Since this sample is nearly the whole portfolio, this result can be inferred for the population.

#### Bar Chart: Electricity Consumption by Geography
```{r}
ggplot(tbl1617, aes(x = Geography, y = Elec, fill = Geography)) +
  geom_col() +
  ggtitle("Total Electricity by Geography",
          subtitle = "(kWh p.a)") +
  ylab("Consumption") +
  scale_fill_calc()+
  theme_minimal() +
  theme(legend.position = 0,
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  # Hide numbers if showing plot publicly
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

```


#### Box Plots: Electricity consumption by Geography
```{r}
ggplot(data = tbl1617, aes(x = Geography, y = Elec, fill = Geography)) +
  geom_boxplot(alpha = 0.5) +
  stat_summary(fun.y = mean,
               geom = "point",
               shape = 4,
               size = 3) +
  ggtitle("Electricity Usage by Geography",
          subtitle = "(kWh per annum)") +
  ylab("Consumption (kWh per annum)") +
  scale_fill_tableau() +
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = 0) +
  # Hide numbers if showing plot publically
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

```

#### Density Plots: Electricity consumption by Geography
```{r}
ggplot(data = tbl1617, aes(x = Elec, fill = Geography)) +
  geom_density(alpha = 0.3) +
  ggtitle("Distribution of Electricity Consumption",
          "by Geography") +
  xlab("Electricity Consumption (kWh p.a.)") +
  ylab("")+
  scale_fill_calc() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust =0.5),
        axis.title = element_text(size = 9))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())


```


### Explore Electricity Use by (Weighted Average) Building Age
```{r echo = T, results = 'hide'}
# Summary Table
summary(tbl1617$BuildAge)

```


#### Scatter Plot: Electricity Consumption vs Building Age: by Geography
```{r}
ggplot(tbl1617, aes(x = BuildAge, y = Elec, colour = Geography)) +
  geom_point(alpha = 0.4) +
  ggtitle("Electricity Consumption vs Building Age",
          subtitle = "by Geographical Zone") +
  ylab("Electricity (kWh p.a.)") +
  scale_colour_calc() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title = element_text(size = 9))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

```


#### Scatter Plot: Electricity Consumption vs Building Age: by School Type
```{r}
ggplot(tbl1617, aes(x = BuildAge, y = Elec, colour = Type)) +
  geom_point(alpha = 0.4) +
  ggtitle("Electricity Consumption vs Building Age",
          subtitle = "by School Type") +
  ylab("Electricity (kWh p.a.)") +
  scale_color_tableau() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title = element_text(size = 9))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

```



#### Electricity vs Discretized Building Age
```{r}
BuildAge_dis <- cut_interval(tbl1617$BuildAge, n = 10)

ggplot(tbl1617, aes(x = BuildAge_dis, y = Elec)) +
  geom_point(alpha = 0.4) + 
  ggtitle("Electricity vs Discretized BuildAge") +
  xlab("Building Age (Discretized)") +
  theme_minimal() +
  theme(axis.title = element_text(size = 9),
        plot.title = element_text(hjust=0.5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank())

```
 
 
 **Comment:** There does not seem to be a clear relationship between a school's electricity consumption and the weighted average age of its buildings (i.e. weighted based on construction zones inside buildings). However, building age in this instance is based on *original construction date*, and does not take into account maintenance or other refurbishment works. More research needs to be undertaken with a different measure of schools' average building age that takes into account more than just original construction dates.

### Exploring Floor Area Distribution
#### Combined Histogram and Boxplot
```{r}
Hist_Area <-  ggplot(tbl1617, aes(x = Area, y = ..density..)) +
  geom_histogram(binwidth = 500, colour = "White", fill = "#3182bd") +
  ggtitle("Floor Area Distribution") +
  ylab("")+
  xlab("")+
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

BP_Area <- ggplot(tbl1617, aes(y = Area, x = "")) +
  geom_boxplot(fill = "#3182bd", outlier.colour = "#3182bd", alpha = 0.5) +
  coord_flip() +
  ylab("Area (m2)")+
  xlab("")+
  theme_minimal()+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

cowplot::plot_grid(Hist_Area, BP_Area, ncol = 1, align = "v") # creates combined plot

```


#### Density Plot: Distribution of Floor Area by School Type
```{r}
ggplot(tbl1617, aes(x = Area, y = ..density..)) +
  geom_density(fill="#3182bd") +
  labs(title = "Distribution of Floor Area",
       subtitle="by School Type",
       y = "",
       x = "Floor Area (m2)")+
  facet_wrap(~Type) +
  theme_minimal()+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```



#### Boxplot of Area by School Type
```{r}
ggplot(tbl1617, aes(y = Area, x = Type)) +
  geom_boxplot()+
  # Hide numbers if showing plot publicly
  theme(axis.text.y = element_blank())

```



### EDA: Correlation Analysis
#### Correlation Matrix
Using the `PerformanceAnalytics::chart.Correlation()` function. The function uses Pearson correlation by default.

```{r}
corrmat <- tbl1617[,c("Elec","Area","Enrol","BuildAge","kWh_m2","kWh_Enrol","Cost","Cost_kWh")]
chart.Correlation(corrmat, pch = 19)

```

**Interesting Insights**
 
 * Very strong positive linear relationship (r = 0.91) between total electricity consumption and total floor Area.
 * Very strong postive linear relationship (r = 0.83) between total electricity consumption and total enrolments, although not as strong as relationship between Elec and Area.
 * Very strong positive linear relationship between total floor Area and total Enrol (r = 0.82)
 * However very weak (negative) correlation between Elec and BuildAge (r = -0.087)
 * Positive and moderate correlation between Average kWh/m2 and total electricity consumption (r = 0.53)
 * Negative, but weak correlation between Average kWh/enrolment and total electricity consumption (r = - 0.017)
 * Almost perfect linear assoc (r = 0.97) between total electricity consumpiton and total Cost (goes without saying...)
 * Negative but weak correlation between average cost per kWh and total electricity consumption (r = - 0.2)

 **Note:** Used the following taxonomy in classifing Pearson correlation:
   
 .00-.19 "very weak"
 .20-.39 "weak"
 .40-.59 "moderate"
 .60-.79 "strong"
 .80-1.0 "very strong"

*Source:* [Pearson's Correlation](http://www.statstutor.ac.uk/resources/uploaded/pearsons.pdf)


#### Closer Look at Selected Scatterplot Correlations
```{r}
## Electricity vs. Floor Area (by School Type)
ggplot(tbl1617, aes(y = Elec, x = Area, colour = Type)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  ggtitle("Electricity vs. Total Floor Area", subtitle = "(by School Type)") +
  xlab("Floor area (m2)") +
  ylab("kilowatt hours per annum") +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())


# Electricity vs. Floor Area (by school type) - Zoomed In
ggplot(tbl1617, aes(y = Elec, x = Area, colour = Type)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
#  geom_smooth(method = "lm", se = FALSE) +
  coord_cartesian(xlim = c(0,10000), ylim=c(0,300000)) +
  ggtitle("Electricity vs. Total Floor Area - Zoomed In", 
          subtitle = "(by School Type)") +
  xlab("Floor area (m2)") +
  ylab("kilowatt hours per annum") +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

# Electricity vs. Floor Area (by school type) - Facetted
ggplot(tbl1617, aes(y = Elec, x = Area, colour = Type)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  facet_wrap(~Type) + 
  ggtitle("Electricity vs Area", subtitle = "by School Type") + 
  xlab("Floor Area (m2)") +
  ylab ("kilowatt hours per annum")+
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, hjust= 0.5),
        plot.subtitle = element_text(size = 10, hjust = 0.5),
        legend.position = "none")+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank())


# Electricity vs. Floor Area - Language vs Primary Schools
ggplot(subset(tbl1617, Type %in% c("Language", "Primary")), aes(y = Elec, x = Area, colour = Type)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  coord_cartesian(xlim = c(0,10000) ) +
  ggtitle("Electricity vs. Total Floor Area", 
          subtitle = "(Language vs Primary Schools)") +
  xlab("Floor area (m2)") +
  ylab("kilowatt hours per annum") +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

# Electricity vs. Floor Area - Primary Schools by Geography
ggplot(data = tbl1617[tbl1617$Type=="Primary",], 
       aes(y=Elec, x = Area, colour = Geography)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  ggtitle("Electricity vs. Floor Area", subtitle = "Primary Schools by Geography")+
  xlab("Floor area (m2)") +
  ylab("kilowatt hours per annum") +
  scale_color_tableau() +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, hjust =0.5),
        plot.subtitle = element_text(size = 10, hjust = 0.5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

```


### Measures of Electricity Variability by School Type
```{r echo = T, results = 'hide'}
# Standard Deviation
tbl1617 %>%
  dplyr::select(Elec, Type) %>%
  group_by(Type) %>%
  summarise(Qty_of_Schools = n(), std_Elec = sd(Elec)) %>%
  arrange(desc(std_Elec))

# Mean Absolute Deviation
tbl1617 %>%
  dplyr::select(Elec, Type) %>%
  group_by(Type) %>%
  summarise(Qty_of_Schools = n(), MeanAbsDev = MeanAbsoluteDeviation(Elec)) %>%
  arrange(desc(MeanAbsDev))

# Median Absolute Deviation*
tbl1617 %>%
  dplyr::select(Elec, Type) %>%
  group_by(Type) %>%
  summarise(Qty_of_Schools = n(), MAD = mad(Elec, constant = 1)) %>%
  arrange(desc(MAD))

# Exploration of Primary Elec Consumption by Geography
tbl1617 %>%
  dplyr::select(Geography, Type, Elec) %>%
  filter(Type == "Primary") %>%
  group_by(Geography) %>%
  summarise(n = n(),
            Mean = mean(Elec), 
            Std = sd(Elec), 
            MAD = mad(Elec, constant = 1)) %>%
  arrange(desc(Mean))


```


**Median Absolute Deviation** referred to since it is a robust statistic given the skewed distributions of electricity consumption. Scaling factor used = 1 to give a pure median absolute deviation, since we can safely assume a non-normal distribution in the electricity consumption of the school population.


### Average kWh/m^2^ by School Type
```{r echo = T, results = 'hide'}
tbl1617 %>%
  dplyr::select(kWh_m2, Type) %>%
  group_by(Type) %>%
  summarise(Qty_of_Schools = n(), Avg_kWh_m2 = mean(kWh_m2)) %>%
  arrange(desc(Avg_kWh_m2))

```


#### Observations:
**Electricity vs. Floor Area (by school type):** 
  
* __Secondary schools__ have more variability in electricity consumption for any given total size of floor area. This is especially the case for those over a total of xxxx m^2^, where consumption variability tends to widen as floor area increases.

* On the other hand, __Primary School__ tend to have the least variability in electricity consumption for any given total floor area. They are also distinct from other school types since they tend to cluster around the lower end of both electricity consumption and floor area.

* __PriSec schools__ appear to be a hybrid of Secondary and Primary schools. Consumption tends to cluster around the smaller end of total floor area, but then becomes more variable as total floor area rises. However they do not have as much variability as Secondary Schools (see median absolute deviation in Measures of Electricity Variability by School Type).

* __Special Schools__ tend to have a higher level of consumption than what is generally expected for schools of a similar floor area. The average electricity consumption per square metre of floor area for Special schools is also consistent with this observation (see Average kWh/m2 by School Type). This is likely due to Special schools having specialised facilities to assist with the care and teaching of students with special physical and/or intellectual needs.

* __Language Schools__ like Special Schools also have a higher level of consumption than most schools of a similar 
floor area (see Electricity vs Floor Area: Language and Primary Schools scatter plot). Nonetheless because there is
such a small number of Language schools in the portfolio it is difficult to draw further inferences for schools of 
this type in general. 




### Electricity vs Enrolments
```{r}
# Plot: Electricity vs. Enrolments (by school type)
ggplot(tbl1617, aes(y = Elec, x = Enrol, colour = Type)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  ggtitle("Electricity vs. Total Enrolments", subtitle = "(by School Type)") +
  xlab("Enrolments") +
  ylab("kilowatt hours per annum") +
  theme_minimal() +
  scale_color_brewer(palette = "Set1")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank())

# Plot: Electricity vs. Enrolments - Zoomed In
ggplot(tbl1617, aes(y = Elec, x = Enrol, colour = Type)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  ggtitle("Electricity vs. Total Enrolments - Zoomed In") +
  xlab("Enrolments") +
  ylab("kilowatt hours per annum") +
  coord_cartesian(xlim = c(0,650)) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1")+
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank())

# Plot: Electricity vs. Enrolments - Facetted by School Type
ggplot(tbl1617, aes(y = Elec, x = Enrol, colour = Type)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  ggtitle("Electricity vs. Total Enrolments", subtitle = "(by School Type)") +
  facet_wrap(~Type) +
  xlab("Enrolments") +
  ylab("kilowatt hours per annum") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5),
        legend.position = "none")+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank())


```


#### Investigate Average kWh per Enrolment - Language Schools
```{r}
meankWhEnrolLang <- tbl1617 %>%
  filter(Type == "Language") %>%
  summarise(mean(kWh_Enrol)) %>% .[[1]]
ggplot(subset(tbl1617, Type == "Language"), 
       aes(y = kWh_Enrol, x = SchoolID)) + 
  geom_col(alpha = 0.5) + 
  geom_hline(yintercept = meankWhEnrolLang, linetype = "dashed", colour = "red") +
  ggtitle("Average Electricity Consumption per Student",
          subtitle = "Language Schools") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

```



### Average kWh/Enrolment by School Type - Summary Stats
```{r echo = T, results = 'hide'}
tbl1617 %>%
  dplyr::select(kWh_Enrol,Type) %>%
  group_by(Type) %>%
  summarise(Avg_kWh_per_Enrol = mean(kWh_Enrol),
            Median_kWh_per_Enrol = median(kWh_Enrol),
            MAD = mad(kWh_Enrol, constant = 1)) %>%
  arrange(desc(Avg_kWh_per_Enrol))

```


#### Observations:
* __Primary schools__ once again show they are a distinctive group, in that their consumption per student is significantly lower than other school types. In fact, this is true across all enrolment numbers approaching xxxx students.  Consumption is also a lot less variable than the other school types except for Language schools. However, per-student consumption variability is on par with Language schools, which is remarkable considering that there are so many more primary schools than language schools. 

 * __Secondary schools__ came in at _third place_ behind __PriSec schools__. This is surprising given that secondary schools ranked higher than PriSec for average consumption per floor area and the strong relationship between floor area and enrolments.  What is also surprising is that __PriSec schools__ had more variability in per-student consumption than Secondary, since the reverse was true for average kWh per floor area. In fact, the variability (median absolute deviation) is significantly more for PriSec than for Secondary.

 * __Special schools__ had the highest average per-enrolment usage out of all the school types. This is not surprising considering the specialised equipment and services required to cater for the wellbeing and learning of these students. 
However, what is surprising is how _high_ the per-student consumption was; practically double than other types of students. What is also surprising is that not only do they have the largest variability, but also that the variability is as 
large as it is, e.g. more than double that for Secondary schools!


### Cost vs. Floor Area and Enrolments (by School Type)
```{r}
# Plot: Cost vs. Floor Area (by school type)
ggplot(tbl1617, aes(y = Cost, x = Area, colour = Type)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  ggtitle("Cost vs. Total Floor Area", subtitle = "(by School Type)") +
  xlab("Floor area (m2)") +
  ylab("Dollars per annum") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank())

```


### Cost vs. Enrolments (by school type)
```{r}
ggplot(tbl1617, aes(y = Cost, x = Enrol, colour = Type)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  ggtitle("Cost vs. Total Enrolments", subtitle = "(by School Type)") +
  xlab("Enrolments") +
  ylab("Dollars per annum") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank())

```



### Cost per Floor Area Histogram 
```{r}
ggplot(tbl1617,aes(x=Cost_m2)) +
  geom_histogram(binwidth = 0.3, 
                 colour = "white",
                 fill = "blue",
                 alpha=0.7,
                 aes(y = ..density..)) +
  labs(title="Electricity Cost per Square Metre",
       y="")+
  coord_cartesian(xlim = c(0,17)) +
  # overlay normal distribution curve
  stat_function(fun = dnorm, colour = "red", 
                args = list(mean = mean(tbl1617$Cost_m2, na.rm = TRUE),
                            sd = sd(tbl1617$Cost_m2, na.rm = TRUE))) +
  theme_minimal()+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        plot.title = element_text(hjust=0.5),
        panel.grid = element_blank())


```



#### Tables Related to Cost
```{r echo = T, results = 'hide'}
## Cost per Area by Type  
tbl1617 %>%
  dplyr::select(Cost_m2, Type) %>%
  group_by(Type) %>%
  summarise(Av_Cost_per_m2 = mean(Cost_m2),
            Median_Cost_per_m2 = median(Cost_m2),
            MAD = mad(Cost_m2, constant = 1)) %>%
  arrange(desc(Av_Cost_per_m2))

## Cost per Enrol by Type
tbl1617 %>%
  dplyr::select(Cost_Enrol, Type) %>%
  group_by(Type) %>%
  summarise(Av_Cost_per_Student = mean(Cost_Enrol),
            Median_Cost_per_Student = median(Cost_Enrol),
            MAD = mad(Cost_Enrol, constant = 1)) %>%
  arrange(desc(Av_Cost_per_Student))

```


#### Observations for cost:
Overall, the relationship between cost and floor area, and cost and enrolments follow a very similar pattern as per electricity consumption. The observations seen earlier with electricity consumption can be extrapolated here to electricity cost. This is not surprising given the very strong (close to perfect) relationship between consumption and cost.


### Schools and Electricity by Geography

#### Tables
```{r echo = TRUE, results = 'hide'}
# Crosstabulation: Count of Schools by School Type and Geography
tbl1617%>%
  tabyl(Type,Geography)%>%
  adorn_totals(where = c("row","col"))%>%
  adorn_percentages()%>%
  adorn_pct_formatting()%>%
  adorn_ns(position = "front")

# Mean Electricity per SQM by Type and Geography
tbl1617 %>%
  group_by(Type, Geography) %>%
  summarise(avg = round(mean(kWh_m2),2)) %>%
  spread(Geography, avg, fill = 0)

```


#### Selected Plots
```{r}
# Plot: Schools Electricity by Type and Geography
ggplot(tbl1617, aes(y = Elec, x = Type, colour = Geography)) +
  geom_point( position = position_jitterdodge(), shape = 1) +
  ggtitle("Schools' Annual Electricity (kWh per annum)",
          subtitle = "by School Type and Geography") +
  scale_color_brewer(palette = "Set1") +
  xlab("") +
  ylab("") +
  scale_colour_calc() +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, hjust = 0.5),
        plot.subtitle = element_text(size = 10, hjust = 0.5))+
  # Hide numbers if showing plot publicly
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank())

# Plot: Electricity vs Floor Area by Geography
ggplot(tbl1617, aes(y = Elec, x = Area, colour = Geography)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  ggtitle("Electricity vs. Total Floor Area", subtitle = "(by Geography)") +
  xlab("Floor area (m2)") +
  ylab("kilowatt hours per annum") +
  scale_colour_calc() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

# Electricity vs. Floor Area (by Geography) - Zoomed In
ggplot(tbl1617, aes(y = Elec, x = Area, colour = Geography)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  coord_cartesian(xlim = c(0,10000) ) +
  ggtitle("Electricity vs. Total Floor Area - Zoomed In", 
          subtitle = "(by Geography)") +
  xlab("Floor area (m2)") +
  ylab("kilowatt hours per annum") +
  scale_colour_calc() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(), 
        panel.grid = element_blank())


# Plot: Electricity vs. Enrol (by Geography)
ggplot(tbl1617, aes(y = Elec, x = Enrol, colour = Geography)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  ggtitle("Electricity vs. Total Enrolments", subtitle = "(by Geography)") +
  xlab("Total Enrolments") +
  ylab("kilowatt hours per annum") +
  scale_colour_calc() +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = .5))+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())


# Plot:Electricity vs Area by Type:Geography - with Facets
ggplot(data = tbl1617, aes(x = Area, y = Elec, colour = Type)) +
  geom_point(alpha = 0.4) +
  facet_grid(Type ~ Geography) +
  ggtitle("Electricity vs Floor Area",
          subtitle = "School Type by Geography") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust =  0.5),
        legend.position = "none")+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_rect(colour = "black",fill=0))

# Plot: Electricity vs Enrol by Type:Geography - with Facets

ggplot(data = tbl1617, aes(x = Enrol, y = Elec, colour = Type)) +
  geom_point(alpha = 0.4) +
  facet_grid(Type ~ Geography) +
  ggtitle("Electricity vs Enrolments",
          subtitle = "School Type by Geography") +
  scale_colour_calc() +
  theme_minimal() +
   theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust =  0.5),
        legend.position = "none")+
  # Hide numbers if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_rect(colour = "black",fill=0))

```



### Solar
#### Solar Summary Statistics: No Solar vs with Solar


```{r echo = T, results = 'hide'}

tbl1617%>%
  mutate(Solar = fct_recode(Solar, "NoSolar"="0","Solar"="1"))%>%
  tabyl(Type,Solar, show_missing_levels = F)%>%
  adorn_totals(where = c("row","col"))%>%
  adorn_percentages()%>%
  adorn_pct_formatting()%>%
  adorn_ns(position = "front")

```
#### Summary of Average kWh/m2: Solar vs No Solar
```{r echo = T, results = 'hide'}
tbl1617 %>%
  group_by(Solar) %>%
  summarise(Avg = round(mean(kWh_m2),2),
            Std = round(sd(kWh_m2),2))

```

#### Plot: Histogram of Average kWh/m2: Solar vs No Solar
```{r}
Solarlabel <- as_labeller(c("0" = "No Solar", "1" = "Solar"))

ggplot(tbl1617) + 
  geom_histogram(aes(x = kWh_m2, y = ..density.., fill = Solar),
                 binwidth = 2.8, colour = "white") +
  scale_x_continuous(breaks = seq(0,50,5)) +
  coord_cartesian(xlim = c(0,50)) +
  facet_wrap(~Solar, nrow = 2, 
             labeller = Solarlabel) +
  scale_fill_brewer(palette = "Set1") +
  ggtitle("Mean kWh/m2", subtitle = "by Solar Status") + 
  ylab("")+
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5),
    legend.position = 0,
    axis.text = element_blank())+
  # Hide numbersSolar if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

```


#### Solar - Summary of Average kWh/Student: No Solar vs Solar
```{r echo = T, results  = 'hide'}
# Summary of Average kWh/Student: Solar vs No Solar
tbl1617 %>%
  group_by(Solar) %>%
  summarise(Avg = round(mean(kWh_Enrol),2),
            Std = round(sd(kWh_Enrol),2))

```


#### Histogram of Average kWh/Student: Solar vs No Solar
```{r}
ggplot(tbl1617, aes(x = kWh_Enrol, y = ..density.., fill = Solar)) +
  geom_histogram(binwidth = 75, colour = "white") +
  facet_wrap(~Solar, nrow = 2, labeller = Solarlabel) +
  scale_fill_brewer(palette = "Set1") +
  ylab(NULL) +
  xlab("kWh per Student") +
  coord_cartesian(xlim = c(0, 1500)) +
  ggtitle("Mean kWh per Student", subtitle = "by Solar Status") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18),
    plot.subtitle = element_text(hjust = 0.5, size  = 14),
    axis.title.y = element_blank(),
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = 0) +
  # Hide numbersSolar if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())
```


#### Solar - Summary of Average kWh/m2: No Solar vs Solar, by School Type

```{r echo = T, results = 'hide'}
tbl1617 %>%
  group_by(Type, Solar) %>%
  summarise(avg = round(mean(kWh_m2),2)) %>%
  spread(Solar, avg)

```


#### Density Plots: Consumption per Square Metre: No Solar vs Solar, by School Type
```{r}
ggplot(tbl1617) +
  geom_density(aes(x = kWh_m2, fill = Type)) +
  facet_grid(Solar ~ Type ,scales = "free", 
             labeller = labeller(Solar = Solarlabel),
             switch = "y") +
  coord_cartesian(xlim = c(0,60)) +
  ylab("") +
  ggtitle("Electricity per SQM (kWh/m2): No Solar vs Solar", subtitle = "by School Type") + 
  theme_minimal() +
  scale_fill_brewer(palette = "Set1") +
  theme(legend.position = 0,
        axis.text.y = element_blank(),
        plot.title = element_text(size = 14, hjust = 0.5),
        plot.subtitle = element_text(size = 10, hjust = 0.5))+
  # Hide numbersSolar if showing plot publicly
  theme(axis.text = element_blank(),
        panel.grid = element_blank())

```


End of exploratory analysis; prepare for model building. Due to very small numbers exclude Language schools from the tibble to be used for model creation:

```{r}
# Small Sample of Language Schools, remove from analysis
tblExLang <- tbl1617 %>%
   filter(Type != "Language") %>%
   mutate(Area.c = Area - mean(Area)) # Mean-centre Area

tblExLang <- droplevels(tblExLang) # drop Language schools from dataframe

```

# Model Creation
_(Added 23 Sep 2018)_

## Model Type: Ordinary Least Squares
__Model Building Methodology:__ Backwards Elimination Starting From Original Full Model a0

__Process:__ order of variable elimination based on:
  * smallest impact observed from prior analyses; and/or
  * smallest level of statistical significance in existing model.
  
Final decision on whether to accept or reject variable elimination based on a combination of:
  * statistical indicators e.g. AIC and BIC, root mean square error (RMSE), adjusted R^2^, Ramsey RESET etc; and
  * information that would reasonably be sought when wanting to understand the factors impacting on school electricity consumption.
  
Note that the explanatory variables chosen are the ones that were seen in prior exploratory analysis to have a significant impact on electricity consumption. Explanatory variables excluded are those that are either not relevant (e.g. cost) or were seen to have no sigficant impact in prior analysis.
  
### Create Root Mean Square Error (RMSE) function

```{r}
rmse <- function(x){
  sqrt(mean(x$residuals^2))
}

```

As the square root of a variance, RMSE can be interpreted as the standard deviation of the unexplained variance, and has the useful property of being in the same units as the response variable. Lower values of RMSE indicate better fit. RMSE is a good measure of how accurately the model predicts the response.

### Original Full Model:

```{r echo=TRUE, results='hide'}
a0 <- lm(Elec~Area + Enrol + Solar + Type + Geography + BCA, data=tblExLang)
summ(a0,robust = T, center = T, vifs=T)
rmse(a0)

```

### 'a-Set' Models: Removal of Variables
#### Removing One Variable
```{r echo=T, results='hide'}
a1.1 <- lm(Elec~Area + Enrol + Solar + Type + Geography, data=tblExLang)
summ(a1.1,center = T, robust = T, vifs=T)

a1.2 <- lm(Elec~Area + Enrol + Solar + Type + BCA, data=tblExLang)
summ(a1.2,center = T, robust = T, vifs=T)

a1.3 <- lm(Elec~Area + Solar + Type + Geography + BCA, data=tblExLang)
summ(a1.3,center = T, robust = T, vifs=T)

a1.4 <- lm(Elec~Enrol + Solar + Type + Geography + BCA, data=tblExLang)
summ(a1.4,center = T, robust = T, vifs=T)

# Group models
a1.models <- list(a0, a1.1, a1.2, a1.3, a1.4)

# Find RMSE
sapply(a1.models,rmse)

# Use Akaike Information Criteria and Bayesian information criterion
sapply(a1.models, AIC) # AIC values
sapply(a1.models, BIC) # BIC values

```

AIC and BIC both prefer model a1.1, which excludes Building Code of Australia (BCA) Climate Zone. However it would be reasonable to expect for a model (or other research) of electricity consumption to explore the impact of climate. The other variables are also expected to be of business interest. However, Area and Enrol are strongly correlated (r^2^=0.82), therefore likely to be high multicollinearity (indicated by VIFs). If one of these variables were to be eliminated, then it would be Enrol, since Area has a stronger linear correlation with total Electricity consumption (r^2^ = 0.90) than Enrol (r^2^ = 0.82). Also prefer a1.3 over a1.4 going by Adj. R^2^ and AIC/BIC. So model of choice is a1.3 over a0.

#### Eliminate Two Variables (including Enrol)
```{r echo=T, results='hide'}
# Eliminate BCA
a2.1 <- lm(Elec~Area+Type+Solar+Geography,data=tblExLang)
summ(a2.1,center = T,robust = T,vifs = T)

# Compare RMSE with a1.3
sapply(list(a1.3, a2.1),rmse)

# Compare AIC and BIC
sapply(list(a1.3, a2.1),AIC)
sapply(list(a1.3, a2.1),BIC)

```

In terms of overall predictive ability and parsimony, a2.1 is preferred over a1.3 (note: a2.1 is nested within a1.3).

#### Eliminate Geography
```{r echo=T, results='hide'}

a3.1 <- lm(Elec~Area+Type+Solar,data=tblExLang)
summ(a3.1,center = T,robust = T,vifs = T)
rmse(a3.1)
# Compare a3.1, a2.1, and a1.3:
# (Note: all three have Adj. R = 0.84)
AIC(a3.1, a2.1, a1.3)
BIC(a3.1, a2.1, a1.3)

```

Model 3.1 has the highest AIC/BIC score, while a2.1 has lowest AIC/BIC score. This indicates further variable elimination would lead to further information loss. It also implies that Geography is important for predictive performance and that Climate Zone (at least in terms of separately comparing Zone 4 and Zone 7 with Zone 6) adds no further explanatory power to a model of this simple functional form.

Thus out of these 'a-Set' models, model a2.1 is the most preferred i.e. lm(Elec~Area+Type+Solar+Geography,data=tblExLang).

#### Test of Model Assumptions

```{r}
avPlots(a2.1) 
# The plot Elec|other vs Area|others shows linearity

par(mfrow = c(2,2))
plot(a2.1)
```

Plot shows evidence of heteroscedaticity as given by the Residuals vs Fitted and Standardised Residuals vs Fitted plots. This implies less efficient OLS estimators (i.e
a larger sample size is required for OLS estimators to converge to the true value). It
also means the variance of the OLS estimators may be both biased an inconsistent. In practice it means that the variance, and therefore standard errors of the estimators are substantially underestimated. This  implies a need for heteroscedasticity-consistent standard errors. 

The Residuals vs Leverage plot shows a number of high leverage observations. However,
there is insuffficient evidence they have any undue influence on the model (as given by Cook's distance lines).  

The Normal Q-Q plot implies a reasonably symmetrical bell curve, but one with thin tails. This can be confirmed via plot below:

```{r}
augment(a2.1)%>%
  ggplot(aes(x=.resid)) + 
  geom_histogram(aes(y=..density..),
                 binwidth = 10000,
                 colour="white", fill="#2b8cbe") +
  stat_function(fun = dnorm,
                args = list(mean=mean(augment(a2.1)$.resid,na.rm=TRUE),
                            sd=sd(augment(a2.1)$.resid,na.rm=TRUE)),
                col="red") +
  labs(title="Model a2.1 Distribution of Residuals",
       subtitle="against Normal Distribution (Red Curve)")+
  coord_cartesian(xlim = c(-3e+5,3e+5))+
  theme(plot.subtitle = element_text(hjust=0.5),
        plot.caption = element_text(hjust=0.5))
```


While the distribution of residuals is leptokurtic (thin-tailed) it seems to be 'normal enough' to assume Normality assumption is met.

**Note:** Model a2.1 with robust std errors and centred continuous predictor Area:
```{r echo=T, results='hide'}
a2.1r <- lm_robust(Elec~Area.c+Type+Solar+Geography,data=tblExLang,
                   se_type = "HC3")

summary(a2.1r)

```

#### Testing of Functional Form: Ramsey RESET test
##### Using reset() function
```{r}
reset(a2.1)
# Reject H0 that there is no model misspecification
# i.e conclude model is misspecified

```


#### Manual Calculation Using Wald Test with F-Distribution
```{r}
# 1) Tidy the lm object
a2.1_tidy <- augment(a2.1)
# head(a2.1_tidy)

# 2) Create nested model with y-hat^2 and y-hat^3
a2.1nst <- lm(Elec~Area+Type+Solar+Geography+I(.fitted^2)+I(.fitted^3),
              data=a2.1_tidy)

# 3) Perform waldtest
# This tests the following Hypothesis: I(.fitted^2) = 0 and I(.fitted^3 = 0)
# Set test = "F" to compute F-statistic with F-distribution

waldtest(a2.1nst,a2.1)
waldtest(a2.1nst,a2.1, test="F")

```

Reject H0 that there is no model misspecification i.e conclude model is misspecified.

#### RESET Test - with Heteroskedasticity-Robust F statistic
__(Also called heteroskedasticity-robust Wald statistic)__

Use the vcov = vcovHC argument to estimate a Heteroskedasticity-Consistent covariance matrix.

```{r}
reset(a2.1,vcov = vcovHC)

waldtest(a2.1nst,a2.1,vcov = vcovHC)


```

Even with Heteroskedasticity-Consistent covariance matrix still reject H0. Therefore conclude model is still misspecified.

### 'b-Set' Models: Involves interaction between Area and (School) Type
Prior analysis has shown interaction between floor area and school type with respect to electricity consumption:

```{r}
tblExLang%>%
  ggplot(aes(x=Area,y=Elec,colour=Type))+
  geom_point(size=0.6, alpha=0.6)+
  geom_smooth(method="lm", se=F,fullrange=T)+
  scale_color_few()+
  coord_cartesian(xlim=c(0,15000),ylim=c(0,500000))+
 facet_wrap(~Geography)+
  labs(title="Annual Electricity Consumption:\nInspecting for Interaction between School Type and Floor Area",
       caption="Visual inspection provides evidence of potential interaction between Area and School Type, as shown by the differing\nslopes for each line.")+
  theme(plot.caption=element_text(hjust=0)) +
  # remove figures if showing publicly
  theme(axis.text=element_blank())

```

#### Interaction Term, with BCA in Model:
```{r echo=TRUE, results='hide'}
b1.1 <- lm(Elec~Area.c*Type+Solar+Geography+BCA,data=tblExLang)
summ(b1.1,robust=T,vifs=T)
rmse(b1.1)

```

#### Interaction Term, without BCA:
```{r echo=TRUE, results='hide'}
# Without BCA:
b1.2 <- lm(Elec~Area.c*Type+Solar+Geography,data=tblExLang)
summ(b1.2, robust=T, vifs=T)
rmse(b1.2)
```

#### Testing AIC and BIC

```{r}
AIC(b1.1, b1.2)
BIC(b1.1, b1.2)
```

Given these AIC/BIC results,the fact that both models have an adj. R of 0.84, it seems that BCA is superfluous and therefore can be removed. Nonetheless it is reasonable to want to know what effect climate zone has on energy use so there's also an argument for leaving in BCA.

However note the very high vifs for Area, Type, and (especially) the Area:Type interactions. This might indicate potential multicollinearity problems for these variables, although further investigation is required to see if an issue actually exists. If multicollinearity is severe enough it can significantly increase the variance (and therefore standard errors) of the coefficient estimates and make the estimates very sensitive to minor changes in the model. The result is that the coefficient estimates are unstable and difficult to interpret. Seeing if there multicollinearity is causing a problem in the model can be performed with techniques like ridge regression.

#### Test of Functional Form - Ramsey RESET Test (b-set models)
__Using Heteroskedasticity-Robust F statistic__

```{r}
reset(b1.1, vcov = vcovHC)
reset(b1.2, vcov = vcovHC)
```

Based on this result model b1.2 deemed to have a correct functional form,
but not much more so than b1.1. However b1.1 seems to have slightly better predictive ability than b1.2 as given by root mean square error. For the sake of choosing just one model b1.2 (without BCA) is preferred over b1.1 (with BCA).

### Model Creation: "c-Set" - Interaction between Geography and BCA
Previous analysis of geography and climate zone concluded that assessing the 
effects of climate needs to be performed at a level that takes into account
local variations. This conclusion was supported by an interaction between
BCA Zone and Geography.

```{r echo=T, results='hide'}
c1.1 <- lm(Elec~Area+Type+Solar+Geography*BCA,data=tblExLang)
summ(c1.1, robust=T, center=T, vifs=F)
```

_"Error in stop_wrap("VIFs cannot be calculated because there are aliased coefficients in the model.") : VIFs cannot be calculated because there are aliased coefficients in the model."_

Note the error message regarding aliased coefficients, and the NAs for the GeographyRural:BCAZone_4 interaction.

Further investigation shows linear dependence on BCAZone_4 and GeographyRegional:BCAZone_4.
```{r}
alias(c1.1)
```

This is not surprising since there are no Urban/metropolitan schools in Climate Zone 4. The coefficient for BCAZone_4, which is practically zero, is also evidence of this. This has resulted in 'singularity' or perfect multicollinearity, which led to unstable results.

Try creating a new Climate Zone variable with different coding of levels:

```{r echo=T, results='hide'}
# Create new variable using data from existing BCA variable:
tblExLang$Zones4Or7 <- tblExLang$BCA
# Recode variables such that the reference level is *not* Zone 4 or Zone 7 
levels(tblExLang$Zones4Or7) <- list("0" = "Zone_6", "1" = c("Zone_4","Zone_7"))

# Create new model
c1.2 <- lm(Elec~Area+Type+Solar+Geography*Zones4Or7,data=tblExLang)
summ(c1.2, center=T, robust=T, vifs=T)
```

Here we've combined Zones 4 and 7 into one level (to represent *not* Zone 6), and this has resolved the singularity issue.

#### Test of Functional Form - Ramsey RESET Test
```{r}
reset(c1.2, vcov=vcovHC)
```

Model c1.2 seems to be impacted by misspecification.

### Model Creation: "d-Set" - Create Model with Area:Type and Geography:BCA Interactions
```{r echo=T, results='hide'}

d1.1 <- lm(Elec~Area*Type+Solar+Geography*Zones4Or7,data=tblExLang)
summ(d1.1, robust=T, center=T, vifs=T)
```

#### Ramsey RESET
```{r}
reset(d1.1, vcov=vcovHC)
```

Reject H0 no model misspecification. Current preferred model still b1.2.

### Model Creation: "e-Set" - Create model with Area:Type interaction and include Zone4or7

```{r echo=TRUE, results='hide'}
e1.1 <- lm(Elec~Area*Type+Solar+Geography+Zones4Or7,data=tblExLang)
summ(e1.1, robust=T,center=T,vifs=T)
```

#### Test of Functional Form - Ramsey RESET
```{r}
reset(e1.1,vcov=vcovHC)
```

Reject H0 of no misspecification (Model b1.2 still our preferred model)

### Model Creation: "f-Set" - Create Model with Area:Type and Area:Solar Interactions

#### Create model with 3-way interaction (f1.1)
```{r echo=T, results='hide'}

f1.1 <- lm(Elec~Area.c*Type*Solar+Geography, data=tblExLang)
summ(f1.1, robust=T, vifs=T)

```

Insufficient evidence of a three-way interaction, and therefore cannot justify building such a (complex) model. Note that non-signficance of t-values may be due to high multicollinearity (as presented by vif figures).

#### Interactions between Area:Type and Area:Solar
Prior analysis has found an interaction between Solar and Area so incorporate here.
```{r echo=T, results='hide'}
f2.1 <- lm(Elec~Area.c*(Type+Solar)+Geography, data=tblExLang)
summ(f2.1,robust = T, vifs=T)
# Alternative version of f2.1
# f2.1.1 <- lm_robust(Elec~Area.c*(Type+Solar)+Geography, data=tblExLang, 
#                     se_type = "HC3")

```

Area and Solar interaction meets the default criterion for statistically significant coefficients (p<0.05). Furthermore prior exploratory analysis has found an interaction between
Solar use and floor area, and conceptually it makes sense for this relationship to be present (i.e. having solar lowers kWh/m2 consumption).So keep this interaction, and assess model further.

#### Test of Functional Form - Ramsey RESET Test (f2.1)
```{r}
reset(f2.1, vcov = vcovHC)
```

Cannot reject H0 of no misspecification (at p = 0.05)

#### Compare Model f2.1 and Model b1.2

```{r}
# Akaike and Bayesian-Schwartz Information Criteria
AIC(f2.1, b1.2)
BIC(f2.1, b1.2)

# Root Mean Square Error
sapply(list(f2.1, b1.2), rmse)



```

Both AIC and BIC favour model f2.1. Also f2.1 has Adj R^2^ = 0.85, which is 
slightly higher than for b1.2 (Adj R^2^ = 0.84), but also has lower root mean square error.

So model f2.1 is preferred over b1.2.

##### Testing Model Assumptions for Model f2.1
```{r}
avPlots(f2.1) 
```


The plot 'Elec|others vs Area.c|others' shows linearity 


```{r}
par(mfrow = c(2,2))
plot(f2.1)

```

Plot shows evidence of heteroscedaticity as given by the Residuals vs Fitted and Standardised Residuals vs Fitted plots. This implies less efficient OLS estimators (i.e a larger sample size is required for OLS estimators to converge to the true value). It  also means the variance of the OLS estimators may be both biased an inconsistent. In practice it means that the variance, and therefore standard errors of the estimators are substantially underestimated. This  implies a need for heteroscedasticity-consistent standard errors. 

The Residuals vs Leverage plot shows a number of high leverage observations. However,there is insuffficient evidence they have any undue influence on the model (as given by Cook's distance lines).  

The Normal Q-Q plot implies a reasonably symmetrical bell curve, but one with thin tails. This can be confirmed via plot below:

```{r}
augment(f2.1)%>%
  ggplot(aes(x=.resid)) + 
  geom_histogram(aes(y=..density..),
                 binwidth = 15000,
                 colour="white", fill="#2b8cbe") +
  stat_function(fun = dnorm,
                args = list(mean=mean(augment(f2.1)$.resid,na.rm=TRUE),
                            sd=sd(augment(f2.1)$.resid,na.rm=TRUE)),
                col="red") +
  labs(title="Model f2.1 Distribution of Residuals",
       subtitle="against Normal Distribution (Red Curve)")+
  coord_cartesian(xlim = c(-3e+5,3e+5))+
  theme(plot.subtitle = element_text(hjust=0.5),
        plot.caption = element_text(hjust=0.5))
```

The distribution is leptokurtic (thin-tailed) but it seems to be 'normal enough' to assume Normality assumption is met.

#### Create Model f3.1: Elec~Area*(Type+Solar)

Model f3.1 is a simplified variation of f2.1 where we are only interested in three  variables: School Type; Area; and Solar Usage. Here we want to simplify assessments without having to consider other intricacies like whether schools are in urban, regional, or rural localities. The aim is to be able to make general statements about electricity consumption with respect to variables of greatest business interest.

```{r echo=T, results='hide'}
f3.1 <- lm(Elec~Area.c*(Type+Solar), data=tblExLang) 
summ(f3.1,robust = T, vifs=T)
```

Area.c:Type interaction not statistically significant.This may be due to high multicollinearity between interacting terms and the main effects). Or it may be due to removing Geography as a factor Area.c:Solar interaction still statistically signficant. 

#### Ramsey RESET test (heteroscedasticity-robust)
```{r}
reset(f3.1, vcov=vcovHC)
```

Result: this rejects H0 of no model misspecification, i.e. test rejects that this is a correctly specified linear model. In other words there are non-linear combinations of the fitted values that help explain the response variable (Electricity consumption).

In this case, we'll explicitly declare that we are working with explicit approximations of a 'true' model, but argue that we can still derive defensible analyses and insights. We can do this by invoking the work of Berk et. al (2017): [Berk, R., Brown, L., Buja, A. et al. J Quant Criminol (2017)](https://doi.org/10.1007/s10940-017-9348-7)

##### Testing Model Assumptions for Model f3.1
```{r}
avPlots(f3.1) 
# The plot Elec|others vs Area.c|others shows linearity


par(mfrow=c(2,2))
plot(f3.1)
# Same conclusions as per previous models.
```

The Normal Q-Q plot implies a reasonably symmetrical bell curve, but one with thin tails. This can be confirmed via plot below:

```{r}
augment(f3.1)%>%
  ggplot(aes(x=.resid)) + 
  geom_histogram(aes(y=..density..),
                 binwidth = 15000,
                 colour="white", fill="#2b8cbe") +
  stat_function(fun = dnorm,
                args = list(mean=mean(augment(f2.1)$.resid,na.rm=TRUE),
                            sd=sd(augment(f2.1)$.resid,na.rm=TRUE)),
                col="red") +
  labs(title="Model f3.1 Distribution of Residuals",
       subtitle="against Normal Distribution (Red Curve)")+
  coord_cartesian(xlim = c(-3e+5,3e+5))+
  theme(plot.subtitle = element_text(hjust=0.5),
        plot.caption = element_text(hjust=0.5))
```

Distribution seems to be 'normal enough' to assume Normality assumption is met.


##### lm_robust version of f3.1:

```{r}
f3.1.1 <- lm_robust(Elec~Area.c*(Type+Solar), data=tblExLang, 
                    se_type = "HC3")


#summary(f3.1.1)

```

#### Calculate Predicted Values based on Model f3.1.1: SET #1
__Assumptions:__
 * Floor area for each School Type is the estimated mean portfolio area (i.e x,xxx m2); and
 * Geography not taken into account.

__Create data separate dataframe__ where the (mean-centred) floor area for the entire portfolio is assumed to be the same across all school types:

```{r}
df.1 <- data.frame(Area = rep(mean(tblExLang$Area)),
                   Area.c = rep(mean(tblExLang$Area.c)),
                   Type = factor(c(rep("Primary",2),
                                   rep("Secondary",2),
                                   rep("PriSec",2),
                                   rep("Special",2)),
                                 levels=c("Primary","Secondary","PriSec","Special")),
                   Solar = factor(rep(c("0","1"),1)))
```


__Generate predictions__ based on Model f3.1.1 using df.1:
```{r}
f3.1.1_pred <- predict(f3.1.1, newdata = df.1,interval = "confidence")
df.pred <- cbind(df.1, f3.1.1_pred) # combine data frame and predicted values
```

__Create table with columns showing:__
* Mean Floor Area
* School type
* Predicted electricity by schools with no solar
* Predicted electricity by schools with Solar
* Difference in predicted electricity no solar vs solar
* % difference in predicted electricity

```{r echo=T, results='hide'}
df.pred%>%
  dplyr::select(-c(2,6:7))%>%
  mutate(Solar=recode_factor(Solar,`0`= "NoSolar",`1` = "Solar"))%>%
  group_by(Type,Solar)%>%
  spread(Solar,fit.fit)%>%
  mutate(Diff=Solar-NoSolar,
         Pct=Solar/NoSolar-1)%>%
  arrange(Pct)%>%
  mutate(Pct = paste(
    round(Pct*100,1),"%")
    )

```

#### Calculate Predicted Values based on Model f3.1.1: SET # 2
__Assumption:__ Floor area for each School Type is the estimated mean area by each School Type

**Get mean Area and mean centred Area** by school Type:
```{r}
Pri.AvM2 <- tapply(tblExLang$Area,tblExLang$Type,mean)[1]
Sec.AvM2 <- tapply(tblExLang$Area,tblExLang$Type,mean)[2]
PriSec.AvM2 <- tapply(tblExLang$Area,tblExLang$Type,mean)[3]
Spec.AvM2 <- tapply(tblExLang$Area,tblExLang$Type,mean)[4]

Pri.AvM2.c <- tapply(tblExLang$Area.c,tblExLang$Type,mean)[1]
Sec.AvM2.c <- tapply(tblExLang$Area.c,tblExLang$Type,mean)[2]
PriSec.AvM2.c <- tapply(tblExLang$Area.c,tblExLang$Type,mean)[3]
Spec.AvM2.c <- tapply(tblExLang$Area.c,tblExLang$Type,mean)[4]  

```

**Create data separate dataframe** where the (mean-centred) floor area is assumed to be the mean floor area by each school type:
```{r}
df.2 <- data.frame(
  Area = c(rep(Pri.AvM2,2),
           rep(Sec.AvM2,2),
           rep(PriSec.AvM2,2),
           rep(Spec.AvM2,2)),
  Area.c = c(rep(Pri.AvM2.c,2),
             rep(Sec.AvM2.c,2),
             rep(PriSec.AvM2.c,2),
             rep(Spec.AvM2.c,2)),
  Type = factor(c(rep("Primary",2),
                  rep("Secondary",2),
                  rep("PriSec",2),
                  rep("Special",2)),
                levels=c("Primary","Secondary","PriSec","Special")),
  Solar = factor(rep(c("0","1"),2)))

```

**Generate predictions based on Model f3.1.1 using df.2:**
```{r}
f3.1.1_pred2 <- predict(f3.1.1, newdata = df.2,interval = "confidence")
df.2.pred <- cbind(df.2, f3.1.1_pred2)   # combine data frame and predicted values
```

__Create table with columns showing:__
* Mean Floor Area
* School type
* Predicted electricity by schools with no solar
* Predicted electricity by schools with Solar
* Difference in predicted electricity no solar vs solar
* % difference in predicted electricity

```{r echo=T, results='hide'}
df.2.pred%>%
  mutate(Solar=recode_factor(Solar,`0`="NoSolar",`1`="Solar"))%>%
  dplyr::select(-c(2,6:7))%>%
  group_by(Type,Solar)%>%
  spread(Solar,fit.fit)%>%
  mutate(Diff=Solar-NoSolar,
         Pct=round(Diff/NoSolar*100,0))%>%
  arrange(Pct)%>%
  mutate(Pct=paste(Pct,"%"))


```

__Summary:__

  * Expect between xx% to xx% decrease with Solar, depending on School Type and assuming no distinction between Urban vs Regional vs Rural schools.
  * Primary schools seem to benefit the most with Solar, followed by Pri/Sec, Secondary and Special.

#### Generate Column Plot based on predictions using data from df.2:

```{r}
df.2.pred%>%
  dplyr::select(-2) %>%
  mutate(Solar = recode_factor(Solar,`0`= "NoSolar",`1`="Solar"))%>%
  group_by(Type, Solar)%>%
  summarise(pred.fit=round(mean(fit.fit/1000),0))%>%
  mutate(End=lag(pred.fit),
         Diff=End-pred.fit,
         Pct=paste(round(Diff/End*100,0),"%"),
         xpos=1:n()-0.5)%>% 
  ggplot(aes(x=Solar,y=pred.fit,fill=Solar))+
  geom_col(position="dodge", alpha=0.6)+
  facet_wrap(~Type,scales="free") + 
  # hide figures if showing plot publicly
  # stat_summary(fun.y = 'mean',
  #              aes(label=scales::comma(..y..)), geom="text",
  #              vjust=1.5)+
  geom_segment(aes(x=xpos,y=End,xend=xpos,yend=pred.fit)) + 
  # hide segment figures if showing plot publicly  
  # geom_text(aes(x=xpos,y=End-Diff/2,label=Pct),hjust=-0.2,size=4)+
  scale_y_continuous(label=scales::comma)+
  scale_fill_tableau()+
  labs(title="Predicted Annual Electricity Consumption*",
       subtitle="By School Type and Solar Usage Status",
       y="Annual Consumption\nMegawatt Hours per Annum (MWh p.a.)",
       x="Solar Usage Status",
       caption="Predicted annual consumption assumes the following average (mean) floor area according to school type: Primary, x,xxx m2; \nSecondary, xx,xxx m2; PriSec, xx,xxx m2; and Special, x,xxx m2.\n*Predictions based on regression analysis of 2016-17 electricity consumption data for 1,xxx schools.\nOne megawatt hour (MWh) = 1,000 kilowatt hours.")+
  theme(text=element_text(size=14),
        plot.subtitle = element_text(hjust=0.5),
        plot.caption = element_text(hjust=0),
        legend.position=0)  + # hide numbers if showing publicly
  theme(axis.text = element_blank())
```

#### Simple Slopes Analysis:

__Store Simple Slope Analysis output:__
```{r}
smpl.slp <- sim_slopes(
  lm(Elec~Area*(Type+Solar),data=tblExLang),
  pred=Area,
  modx = Type,
  mod2 = Solar,
  centered="Area",
  robust=TRUE
  #  cond.int=TRUE,
  #  confint=TRUE
) 
```

__Construct table of Simple Slope Analysis:__
```{r}
Type <- smpl.slp$slopes[[1]][,1]
Est.NoSolar <- smpl.slp$slopes[[1]][,2]
Est.NoSolar.LB <- smpl.slp$slopes[[1]][,4]
Est.NoSolar.UB <- smpl.slp$slopes[[1]][,5]
Est.Solar <- smpl.slp$slopes[[2]][,2]
Est.Solar.LB <- smpl.slp$slopes[[2]][,4]
Est.Solar.UB <- smpl.slp$slopes[[2]][,5]

df.smpl.slp <- cbind.data.frame(
  Type,Est.NoSolar,
  Est.NoSolar.LB, 
  Est.NoSolar.UB,
  Est.Solar,
  Est.Solar.LB,
  Est.Solar.UB) 

# Inspect class of each column:
sapply(df.smpl.slp[1:7], class)

```

All columns are currently a factor. Convert 2nd column onwards into numeric, round to 2 decimal places:
```{r}
for(i in 2:ncol(df.smpl.slp))
  { 
  df.smpl.slp[,i] <- round(
    as.double(
      # convert factors to character before turning to numeric
      as.character(df.smpl.slp[,i])),2)
  }


# Re-inspect class of each column:
sapply(df.smpl.slp[1:7], class)

```

Directly compare Estimated Average Rate of consumption per square metre (kWh/m2) across School Type and Solar Usage:

```{r echo=T, results='hide'}
df.smpl.slp%>%
  dplyr::select(c(1:2,5))%>%
  # sort highest to lowest kWh/m2
  arrange(-Est.NoSolar)%>%
  mutate(Diff=Est.Solar-Est.NoSolar,
         Pct=paste(round(Diff/Est.NoSolar,3)*100,"%"))

```

#### Produce Visual Representation of Model f3.1.1

```{r}
# Combine original dataframe with predicted values generated by Model f3.1.1
f3.1.1_pred_3 <-cbind(tblExLang,
  predict(f3.1.1, # f3.1.1 is lm_robust object
  newdata=tblExLang,se.fit=T,interval="confidence"))

# Save Mean Floor Area by School Type:
MeanM2 <- f3.1.1_pred_3%>%
  group_by(Type)%>%
  summarise(MnM2=mean(Area),
            MinY=min(fit.fit/1000))

# geom_text x and y coordinate multipliers:
xcmult <- 1.15
ycmult <- 1.8

# Produce plot using above objects:
f3.1.1_pred_3%>%
  mutate(Solar=recode_factor(Solar,`0`="NoSolar",`1`="Solar"))%>%
  ggplot(aes(x=Area,y=Elec/1000,colour=Solar))+
  geom_point(size=0.8)+
  geom_smooth(aes(x=Area,y=fit.fit/1000),
              method="lm",
              fullrange=F,
              se=F)+
  geom_ribbon(aes(ymin=fit.lwr/1000,ymax=fit.upr/1000,fill=Solar),
              alpha=0.1,
              colour=NA)+
  scale_x_continuous(label=scales::comma)+
  scale_y_continuous(label=scales::comma)+
  labs(title="Estimated Annual School Electricity Consumption",
       subtitle="By School Type & Solar Status",
       y="Electricity Consumption\nMegawatt Hours per Annum (MWh p.a.)",
       x="Total Floor Area (m2)",
       caption="This is a visual representation of estimated annual school electricity consumption based on regression analysis that considers floor area, school type, and whether\nor not solar is used. The points represent observed consumption over the 2016-17 period across xxxx Primary,\nSecondary, Pri/Sec and Special schools, while the lines give expected values of consumption as predicted by\nregression modelling. The shaded bands around the lines represent how confident we can be in the calculated\nestimates i.e. narrower bands indicate greater certainty about estimated consumption for a given size of floor area.")+
  facet_wrap(~Type,scales="free")+
  geom_vline(data=MeanM2,aes(group=Type,xintercept=MnM2),
             linetype="dotted",
             color="blue")+
  geom_text(data=MeanM2,
            aes(x=MnM2*xcmult,
                y=MinY*ycmult,
                # hide numbers if showing plot publicly:
                # label=paste("Mean area =",
                #         scales::comma(round(MnM2,0)),"m2")
                
                label=paste("Mean area = xx,xxx m2")),
            inherit.aes = F,
            colour="blue",
            size=3,
            hjust=-0.01)+
  scale_color_colorblind()+
  theme(text=element_text(size=14),
        plot.subtitle = element_text(hjust=0.5),
        plot.caption = element_text(hjust=0.0, size=9)
        #        axis.text = element_text(size=11),
        #        axis.title = element_text(size=11)
  ) + 
  # hide axis numbers if showing publicly
  theme(axis.text = element_blank())




```


